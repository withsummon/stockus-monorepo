---
phase: 03-content-api
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - backend/src/routes/courses.ts
  - backend/src/routes/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create courses with sessions"
    - "Admin can update existing courses"
    - "Admin can soft-delete courses"
    - "Authenticated users can list and view courses"
    - "Free preview content visible to all authenticated users"
    - "Members-only content restricted by tier"
  artifacts:
    - path: "backend/src/routes/courses.ts"
      provides: "Course CRUD endpoints"
      exports: ["courseRoutes"]
    - path: "backend/src/routes/index.ts"
      provides: "Route mounting for /courses"
      contains: "routes.route.*courses"
  key_links:
    - from: "backend/src/routes/courses.ts"
      to: "backend/src/middleware/auth.ts"
      via: "authMiddleware, requireAdmin, requireTier imports"
      pattern: "import.*authMiddleware.*requireAdmin"
    - from: "backend/src/routes/courses.ts"
      to: "backend/src/db/schema/courses.ts"
      via: "schema imports for queries"
      pattern: "import.*courses.*courseSessions"
---

<objective>
Implement CRUD endpoints for courses with sessions including tier-based access control.

Purpose: Courses are the primary content type for the education platform. This plan delivers the full course API including nested session management.
Output: Course routes file with list, get, create, update, delete endpoints plus session CRUD.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-api/03-RESEARCH.md
@.planning/phases/03-content-api/03-CONTEXT.md
@.planning/phases/03-content-api/03-01-SUMMARY.md
@.planning/phases/03-content-api/03-02-SUMMARY.md

@backend/src/routes/auth.ts
@backend/src/middleware/auth.ts
@backend/src/db/schema/courses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create course routes with CRUD operations</name>
  <files>
    backend/src/routes/courses.ts
  </files>
  <action>
Create courses.ts with full CRUD operations:

**Imports:**
- Hono, zValidator from @hono/zod-validator, z from zod
- db from ../db/index.js
- courses, courseSessions and relations from ../db/schema/index.js
- authMiddleware, requireAdmin, requireTier, AuthEnv from ../middleware/auth.js (requireTier ALREADY EXISTS from Phase 2 â€” just import it)
- generateSlug, createUniqueSlug from ../utils/slug.js
- eq, desc, isNull, and, asc from drizzle-orm

**Zod Schemas:**
```typescript
const createCourseSchema = z.object({
  title: z.string().min(3).max(255),
  description: z.string().optional(),
  content: z.string().optional(), // HTML content
  thumbnailUrl: z.string().url().optional().nullable(),
  isFreePreview: z.boolean().default(false),
})

const updateCourseSchema = createCourseSchema.partial()

const createSessionSchema = z.object({
  title: z.string().min(1).max(255),
  description: z.string().optional(),
  sessionOrder: z.number().int().positive(),
  durationMinutes: z.number().int().positive().optional(),
})

const updateSessionSchema = createSessionSchema.partial()
```

**Endpoints:**

1. **GET /** - List courses (auth required)
   - Apply authMiddleware
   - Query courses where deletedAt IS NULL, status = 'published'
   - Include sessions ordered by sessionOrder
   - For non-members, filter to only isFreePreview = true OR return all but mark restricted
   - Return { courses: [...] }

2. **GET /:idOrSlug** - Get single course (auth required)
   - Apply authMiddleware
   - If param is numeric, query by id; else query by slug
   - Check tier access: if !isFreePreview and userTier !== 'member', return 403
   - Include sessions
   - Return { course }

3. **POST /** - Create course (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with createCourseSchema
   - Generate unique slug from title
   - Set status = 'published' (no draft per CONTEXT.md)
   - Insert and return { course }

4. **PATCH /:id** - Update course (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with updateCourseSchema
   - If title changed, regenerate slug
   - Update updatedAt
   - Return { course }

5. **DELETE /:id** - Soft delete course (admin only)
   - Apply authMiddleware, requireAdmin()
   - Set deletedAt = new Date(), status = 'archived'
   - Return { message: 'Course deleted' }

6. **POST /:courseId/sessions** - Add session (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with createSessionSchema
   - Insert session linked to courseId
   - Return { session }

7. **PATCH /:courseId/sessions/:sessionId** - Update session (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with updateSessionSchema
   - Update session
   - Return { session }

8. **DELETE /:courseId/sessions/:sessionId** - Delete session (admin only)
   - Apply authMiddleware, requireAdmin()
   - Delete session (hard delete - sessions cascade from course)
   - Return { message: 'Session deleted' }

Export: `export const courseRoutes = courses`
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
courses.ts exports courseRoutes with 8 endpoints covering course and session CRUD
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount course routes</name>
  <files>
    backend/src/routes/index.ts
  </files>
  <action>
Update routes/index.ts to mount course routes:

1. Import courseRoutes from ./courses.js
2. Add route mounting: `routes.route('/courses', courseRoutes)`

The file should look like:
```typescript
import { Hono } from 'hono'
import health from './health.js'
import { auth } from './auth.js'
import { courseRoutes } from './courses.js'

const routes = new Hono()

// Health check routes
routes.route('/health', health)

// Authentication routes
routes.route('/auth', auth)

// Content routes
routes.route('/courses', courseRoutes)

export default routes
```
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
Course routes mounted at /courses/* and application compiles
  </done>
</task>

</tasks>

<verification>
- [ ] courses.ts has all 8 endpoints (3 course CRUD + 2 list/get + 3 session CRUD)
- [ ] Auth middleware applied to all endpoints
- [ ] Admin-only middleware on write operations
- [ ] Tier access control on read operations for members-only content
- [ ] Routes mounted in index.ts
- [ ] TypeScript compiles: `cd backend && npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can create, update, soft-delete courses via API
- Admin can manage sessions within courses
- Authenticated users can list/view courses
- Members-only content properly gated (403 for free users on non-preview content)
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-api/03-03-SUMMARY.md`
</output>
