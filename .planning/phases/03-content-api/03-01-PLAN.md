---
phase: 03-content-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/admins.ts
  - backend/src/db/schema/courses.ts
  - backend/src/db/schema/research.ts
  - backend/src/db/schema/templates.ts
  - backend/src/db/schema/images.ts
  - backend/src/db/schema/cohorts.ts
  - backend/src/db/schema/index.ts
  - backend/src/middleware/auth.ts
autonomous: true

must_haves:
  truths:
    - "Database schema exists for all content types"
    - "Admin check is available as middleware"
    - "Drizzle can query relations between courses/sessions and cohorts/sessions"
  artifacts:
    - path: "backend/src/db/schema/courses.ts"
      provides: "courses and courseSessions tables with relations"
      contains: "coursesRelations"
    - path: "backend/src/db/schema/cohorts.ts"
      provides: "cohorts and cohortSessions tables with relations"
      contains: "cohortsRelations"
    - path: "backend/src/db/schema/admins.ts"
      provides: "admins table with userId reference"
      contains: "admins"
    - path: "backend/src/middleware/auth.ts"
      provides: "requireAdmin middleware"
      exports: ["requireAdmin"]
  key_links:
    - from: "backend/src/db/schema/courses.ts"
      to: "backend/src/db/schema/index.ts"
      via: "barrel export"
      pattern: "export.*from.*courses"
    - from: "backend/src/middleware/auth.ts"
      to: "database admins table"
      via: "db query in middleware"
      pattern: "db\\.query\\.admins"
---

<objective>
Create database schemas for all content types and add admin authorization middleware.

Purpose: Establish the data layer foundation that all content routes will depend on. Without schemas, no CRUD operations are possible.
Output: Database schema files for courses, research, templates, cohorts, admins, and requireAdmin middleware.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-api/03-RESEARCH.md
@.planning/phases/03-content-api/03-CONTEXT.md

@backend/src/db/schema/index.ts
@backend/src/db/schema/users.ts
@backend/src/middleware/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin and content database schemas</name>
  <files>
    backend/src/db/schema/admins.ts
    backend/src/db/schema/courses.ts
    backend/src/db/schema/research.ts
    backend/src/db/schema/templates.ts
    backend/src/db/schema/images.ts
    backend/src/db/schema/cohorts.ts
    backend/src/db/schema/index.ts
  </files>
  <action>
Create database schema files following the research patterns:

**admins.ts:**
- Create `admins` table: id (serial), userId (integer, references users.id, unique), createdAt
- This follows the CONTEXT.md decision: "Admin role: Separate admin table (not boolean flag on users)"

**courses.ts:**
- Create `contentStatusEnum` pgEnum: 'published', 'archived' (no 'draft' per CONTEXT.md "save = live")
- Create `courses` table: id, title, slug (unique), description, thumbnailUrl, content (text for HTML), status, isFreePreview (boolean), deletedAt (nullable for soft delete), createdAt, updatedAt
- Create `courseSessions` table: id, courseId (references courses.id with cascade), title, description, sessionOrder, durationMinutes, videoUrl (for Phase 5), createdAt
- Create relations with `relations()` from drizzle-orm

**research.ts:**
- Create `researchReports` table: id, title, slug (unique), summary, content (text), publishedAt, status, isFreePreview, deletedAt, createdAt, updatedAt
- Follow same pattern as courses

**templates.ts:**
- Create `templates` table: id, title, description, originalFilename, filename (UUID-based, unique), filepath, fileSize, mimeType, isFreePreview, uploadedBy (references users.id), deletedAt, createdAt
- No relations needed - standalone files per CONTEXT.md

**images.ts:** (for CONT-05 media library)
- Create `images` table: id, originalFilename, filename (UUID-based, unique), filepath, fileSize, mimeType, alt (optional text), description (optional text), uploadedBy (references users.id), deletedAt (nullable for soft delete), createdAt
- Used for media library management (thumbnails, content images)
- No relations needed - images are standalone with filepath usable as URL reference

**cohorts.ts:**
- Create `cohortStatusEnum` pgEnum: 'upcoming', 'open', 'closed', 'completed'
- Create `cohorts` table: id, courseId (references courses.id with cascade), name, startDate, endDate, enrollmentOpenDate, enrollmentCloseDate, status, maxParticipants, deletedAt, createdAt, updatedAt
- Create `cohortSessions` table: id, cohortId (references cohorts.id with cascade), courseSessionId (optional, references courseSessions.id, set null on delete), title, scheduledAt, zoomLink, recordingUrl, sessionOrder, createdAt
- Create relations for cohorts â†’ sessions

**index.ts:**
- Add exports for all new schema files

Use `timestamp('column', { mode: 'date' })` consistently for all timestamp columns. Add `{ onDelete: 'cascade' }` to foreign keys where parent deletion should cascade. Add `{ onDelete: 'set null' }` for cohortSessions.courseSessionId.
  </action>
  <verify>
Run `npx tsc --noEmit` from backend/ directory - no TypeScript errors
  </verify>
  <done>
All schema files exist, export correctly from index.ts, and pass TypeScript compilation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create requireAdmin middleware</name>
  <files>
    backend/src/middleware/auth.ts
  </files>
  <action>
Add `requireAdmin` middleware to the existing auth.ts file:

1. Import db from '../db/index.js' and admins table from schema
2. Create `requireAdmin()` middleware function that:
   - Gets userId from context (assumes authMiddleware already ran)
   - Queries admins table to check if user is admin: `db.query.admins.findFirst({ where: eq(admins.userId, userId) })`
   - Returns 403 with `{ error: 'Admin access required' }` if not found
   - Calls `next()` if admin
3. Export the function

This middleware should be used AFTER authMiddleware in route chains:
`app.post('/courses', authMiddleware, requireAdmin(), handler)`
  </action>
  <verify>
Run `npx tsc --noEmit` from backend/ - verify requireAdmin is exported and compiles without errors
  </verify>
  <done>
requireAdmin middleware exists, queries admins table, returns 403 for non-admins, and is exported from auth.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate and run database migration</name>
  <files>
    backend/drizzle.config.ts
  </files>
  <action>
1. Update drizzle.config.ts to include new schema files in the schema array:
   ```
   schema: [
     './src/db/schema/users.ts',
     './src/db/schema/tokens.ts',
     './src/db/schema/sessions.ts',
     './src/db/schema/admins.ts',
     './src/db/schema/courses.ts',
     './src/db/schema/research.ts',
     './src/db/schema/templates.ts',
     './src/db/schema/images.ts',
     './src/db/schema/cohorts.ts',
   ]
   ```

2. Generate migration: `npm run db:generate` (uses tsx as runner per 02-01 decision)

3. If database is running, run migration: `npm run db:migrate`
   - If database not available, document that migration needs to be run

Note: Migration might fail if PostgreSQL is not running - that's expected for local dev setup.
  </action>
  <verify>
Migration file(s) created in backend/drizzle/ directory. Check with `ls backend/drizzle/*.sql` or similar.
  </verify>
  <done>
Migration files generated containing CREATE TABLE statements for admins, courses, course_sessions, research_reports, templates, images, cohorts, cohort_sessions tables
  </done>
</task>

</tasks>

<verification>
- [ ] All schema files exist and export from index.ts
- [ ] TypeScript compiles without errors: `cd backend && npx tsc --noEmit`
- [ ] requireAdmin middleware is exported from auth.ts
- [ ] Migration files generated in backend/drizzle/
- [ ] Schema includes relations for courses/sessions and cohorts/sessions
</verification>

<success_criteria>
- Database schemas for all 8 tables (admins, courses, courseSessions, researchReports, templates, images, cohorts, cohortSessions) exist
- Drizzle relations defined for parent-child relationships
- requireAdmin middleware can check admin status from database
- Migration ready to apply when database is running
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-api/03-01-SUMMARY.md`
</output>
