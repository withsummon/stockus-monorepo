---
phase: 08-admin-dashboard
plan: 06
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - frontend/src/app/(admin)/admin/templates/page.tsx
  - frontend/src/app/(admin)/admin/templates/columns.tsx
  - frontend/src/app/(admin)/admin/templates/new/page.tsx
  - frontend/src/app/(admin)/admin/templates/[id]/page.tsx
  - frontend/src/lib/api/admin.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all templates in a table"
    - "Admin can upload a new template with file"
    - "Admin can edit template metadata"
    - "Admin can delete a template"
  artifacts:
    - path: "frontend/src/app/(admin)/admin/templates/page.tsx"
      provides: "Template list page with data table"
      contains: "DataTable"
    - path: "frontend/src/app/(admin)/admin/templates/new/page.tsx"
      provides: "Upload template form"
      contains: "FormData"
  key_links:
    - from: "frontend/src/app/(admin)/admin/templates/new/page.tsx"
      to: "POST /templates"
      via: "multipart form submit"
      pattern: "FormData"
---

<objective>
Build template management interface with list view, upload form, and edit form.

Purpose: Enables admins to manage downloadable templates (ADMN-01 requirement). Templates require file upload handling.

Output:
- Template list page with DataTable
- Upload template page with file input
- Edit template metadata page
- Delete functionality
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-dashboard/08-RESEARCH.md
@.planning/phases/08-admin-dashboard/08-01-SUMMARY.md
@.planning/phases/08-admin-dashboard/08-02-SUMMARY.md

# Backend template routes with file upload:
@backend/src/routes/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template API functions and types</name>
  <files>
    frontend/src/lib/api/admin.ts
  </files>
  <action>
Add to frontend/src/lib/api/admin.ts:

```typescript
// Template types
export interface Template {
  id: number
  title: string
  slug: string
  description: string
  category: string
  fileUrl: string
  fileSize: number
  isFreePreview: boolean
  downloadCount: number
  createdAt: string
  updatedAt: string
}

export async function getAdminTemplates() {
  const data = await adminFetch('/templates')
  return data.templates as Template[]
}

export async function getAdminTemplate(id: number) {
  const data = await adminFetch(`/templates/${id}`)
  return data.template as Template
}

// Note: createTemplate uses FormData for file upload
// This is handled separately in the client component

export async function updateTemplate(id: number, data: { title?: string; description?: string; category?: string; isFreePreview?: boolean }) {
  return adminFetch(`/templates/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  })
}

export async function deleteTemplate(id: number) {
  return adminFetch(`/templates/${id}`, {
    method: 'DELETE',
  })
}
```

Note: Template creation requires multipart/form-data for file upload, which needs to be handled directly in the client component, not through the adminFetch helper.
  </action>
  <verify>
TypeScript compiles. Functions exported.
  </verify>
  <done>
Template API functions added with type definitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create template list page with DataTable</name>
  <files>
    frontend/src/app/(admin)/admin/templates/page.tsx
    frontend/src/app/(admin)/admin/templates/columns.tsx
  </files>
  <action>
1. Create frontend/src/app/(admin)/admin/templates/columns.tsx:

Column definitions:
- title: Template name
- category: Category badge
- fileSize: Formatted file size (KB/MB)
- isFreePreview: Access level
- downloadCount: Number of downloads
- createdAt: Date
- actions: Edit/Delete dropdown

File size formatting helper:
```typescript
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
}
```

2. Create frontend/src/app/(admin)/admin/templates/page.tsx:

Client component following same pattern:
- Fetch templates on mount
- DataTable with columns
- "Upload Template" button linking to /admin/templates/new
- Delete functionality

Add search filter by title or category.
  </action>
  <verify>
Template list renders. File sizes display correctly.
  </verify>
  <done>
Template list shows all templates with file size and download count columns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create template upload and edit forms</name>
  <files>
    frontend/src/app/(admin)/admin/templates/new/page.tsx
    frontend/src/app/(admin)/admin/templates/[id]/page.tsx
  </files>
  <action>
1. Create frontend/src/app/(admin)/admin/templates/new/page.tsx:

Template upload requires multipart/form-data:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
// ... other imports

const templateSchema = z.object({
  title: z.string().min(3).max(255),
  description: z.string().optional(),
  category: z.string().min(1),
  isFreePreview: z.boolean().default(false),
})

export default function NewTemplatePage() {
  const [file, setFile] = useState<File | null>(null)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const router = useRouter()

  const form = useForm({
    resolver: zodResolver(templateSchema),
    defaultValues: {
      title: '',
      description: '',
      category: '',
      isFreePreview: false,
    },
  })

  async function onSubmit(data: z.infer<typeof templateSchema>) {
    if (!file) {
      // Show error - file required
      return
    }

    setIsSubmitting(true)
    try {
      const formData = new FormData()
      formData.append('file', file)
      formData.append('title', data.title)
      if (data.description) formData.append('description', data.description)
      formData.append('category', data.category)
      formData.append('isFreePreview', String(data.isFreePreview))

      const res = await fetch(`${API_URL}/templates`, {
        method: 'POST',
        credentials: 'include',
        body: formData, // No Content-Type header - browser sets it with boundary
      })

      if (res.ok) {
        router.push('/admin/templates')
      } else {
        const error = await res.json()
        // Show error
      }
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    // Form with:
    // - Title input
    // - Description textarea
    // - Category input (or select with predefined categories)
    // - File input with drag-drop zone or button
    // - Free Preview checkbox
    // - Submit button
  )
}
```

File input component:
- Show selected file name and size
- Allow changing file before submit
- Validate file type (spreadsheets, documents)

Category suggestions: "Spreadsheet", "Document", "Analysis", "Tracking", "Calculation"

2. Create frontend/src/app/(admin)/admin/templates/[id]/page.tsx:

Edit page for metadata only (cannot change file):
- Title
- Description
- Category
- Free Preview checkbox

Show current file info (name, size, download count) as read-only.
Note: To change file, admin should delete and re-upload.
  </action>
  <verify>
Upload form handles file selection and submits correctly. Edit form updates metadata.
  </verify>
  <done>
Template upload form with file input. Edit form for metadata only. Both validate with Zod.
  </done>
</task>

</tasks>

<verification>
1. Template list shows all templates with file info
2. Upload form accepts file and metadata
3. File upload submits as multipart/form-data
4. Edit form updates metadata (not file)
5. Delete removes template
</verification>

<success_criteria>
- Admin can view all templates in DataTable
- Admin can upload new template with file
- Admin can edit template metadata
- Admin can delete template
- File size displays in human-readable format
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-dashboard/08-06-SUMMARY.md`
</output>
