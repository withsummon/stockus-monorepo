---
phase: 08-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/admin.ts
  - backend/src/routes/index.ts
  - frontend/src/app/(admin)/layout.tsx
  - frontend/src/app/(admin)/admin/page.tsx
  - frontend/src/components/admin/AdminSidebar.tsx
  - frontend/src/lib/auth/admin.ts
autonomous: true

must_haves:
  truths:
    - "Admin layout exists with sidebar navigation"
    - "Non-admin users are redirected to /dashboard"
    - "Backend /admin/metrics endpoint returns aggregated data"
    - "Backend /admin/users endpoint returns user list"
    - "Backend /admin/orders endpoint returns payment history"
  artifacts:
    - path: "frontend/src/app/(admin)/layout.tsx"
      provides: "Admin layout with auth verification"
      contains: "checkIsAdmin"
    - path: "frontend/src/components/admin/AdminSidebar.tsx"
      provides: "Admin navigation sidebar"
      contains: "navigation"
    - path: "backend/src/routes/admin.ts"
      provides: "Admin-only API endpoints"
      exports: ["adminRoutes"]
  key_links:
    - from: "frontend/src/app/(admin)/layout.tsx"
      to: "frontend/src/lib/auth/admin.ts"
      via: "checkIsAdmin import"
      pattern: "checkIsAdmin"
    - from: "backend/src/routes/admin.ts"
      to: "backend/src/middleware/auth.ts"
      via: "requireAdmin middleware"
      pattern: "requireAdmin\\(\\)"
---

<objective>
Create admin panel foundation with route group layout, sidebar navigation, and backend API endpoints for metrics, users, and orders.

Purpose: Establishes the admin infrastructure that all content management pages will use. Separates admin from member area using Next.js route groups.

Output:
- Admin route group with protected layout
- AdminSidebar component with navigation
- Backend admin routes (metrics, users, orders)
- Admin auth verification helper
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-admin-dashboard/08-RESEARCH.md

# Key existing patterns to follow:
@frontend/src/app/(auth)/layout.tsx
@frontend/src/components/member/Sidebar.tsx
@frontend/src/lib/auth/dal.ts
@backend/src/middleware/auth.ts
@backend/src/routes/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend admin routes</name>
  <files>
    backend/src/routes/admin.ts
    backend/src/routes/index.ts
  </files>
  <action>
Create admin routes file at backend/src/routes/admin.ts with:

1. GET /admin/metrics - Returns dashboard KPIs:
   - totalMembers: count of users where tier='member'
   - totalRevenue: sum of payments where status='capture' or status='settlement'
   - activeSubscriptions: count of subscriptions where status='active'
   - recentOrders: count of payments in last 30 days
   - Use Drizzle count() and sum() aggregations

2. GET /admin/users - Returns paginated user list:
   - Query params: page (default 1), limit (default 20), search (optional)
   - Returns: users array with id, email, name, tier, isVerified, createdAt
   - Include subscription status if exists (join subscriptions table)
   - Filter by search term on email or name if provided
   - Order by createdAt desc

3. GET /admin/orders - Returns paginated payment history:
   - Query params: page (default 1), limit (default 20), status (optional filter)
   - Returns: payments array with user info joined
   - Include user.name, user.email with each payment
   - Order by createdAt desc

All routes use authMiddleware + requireAdmin() middleware chain.

Register in backend/src/routes/index.ts:
- import { adminRoutes } from './admin.js'
- routes.route('/admin', adminRoutes)
  </action>
  <verify>
Backend compiles without errors. Routes are registered in index.ts.
  </verify>
  <done>
GET /admin/metrics returns { metrics: { totalMembers, totalRevenue, activeSubscriptions, recentOrders } }
GET /admin/users returns { users: [...], total, page, limit }
GET /admin/orders returns { orders: [...], total, page, limit }
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin auth helper and layout</name>
  <files>
    frontend/src/lib/auth/admin.ts
    frontend/src/app/(admin)/layout.tsx
    frontend/src/app/(admin)/admin/page.tsx
  </files>
  <action>
1. Create frontend/src/lib/auth/admin.ts:
   - Import 'server-only' at top
   - Import cache from 'react', cookies from 'next/headers'
   - Create checkIsAdmin function that:
     - Gets access_token cookie
     - Makes GET request to ${process.env.API_URL}/admin/metrics (any admin route works as auth check)
     - Returns true if 200 OK, false otherwise
     - Cache the result with React cache() for request lifecycle
   - Create requireAdmin function that:
     - Calls getUser() from dal.ts
     - If no user, redirect to /login
     - Calls checkIsAdmin()
     - If not admin, redirect to /dashboard
     - Returns user

2. Create frontend/src/app/(admin)/layout.tsx:
   - Server component
   - Call requireAdmin() to verify admin access
   - Render AdminSidebar + children in flex layout
   - Similar structure to (auth)/layout.tsx but with admin styling

3. Create placeholder frontend/src/app/(admin)/admin/page.tsx:
   - Simple "Admin Dashboard" heading
   - Will be replaced with full metrics in Plan 03
  </action>
  <verify>
pnpm build in frontend succeeds. Visiting /admin without admin access redirects to /dashboard.
  </verify>
  <done>
Admin layout protects all /admin/* routes. Non-admins redirected to /dashboard. Placeholder dashboard page renders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AdminSidebar component</name>
  <files>
    frontend/src/components/admin/AdminSidebar.tsx
  </files>
  <action>
Create AdminSidebar component following the pattern from member Sidebar.tsx:

1. 'use client' directive (needs usePathname)
2. Import icons from lucide-react: LayoutDashboard, BookOpen, FileText, FileSpreadsheet, Video, Calendar, Users, CreditCard
3. Define navigation array:
   - Dashboard: /admin (icon: LayoutDashboard)
   - Courses: /admin/courses (icon: BookOpen)
   - Research: /admin/research (icon: FileText)
   - Templates: /admin/templates (icon: FileSpreadsheet)
   - Videos: /admin/videos (icon: Video)
   - Cohorts: /admin/cohorts (icon: Calendar)
   - Users: /admin/users (icon: Users)
   - Orders: /admin/orders (icon: CreditCard)

4. Accept user prop (User type from @/types/auth)
5. Display user info at top with "Admin" badge (use destructive/10 color for admin distinction)
6. Navigation items with active state detection
7. "Back to Member Area" link at bottom pointing to /dashboard
8. Use same styling patterns as member Sidebar (bg-muted/30, primary/10 for active, etc.)

Active state logic:
- For /admin exactly, check pathname === '/admin'
- For others, check pathname.startsWith(item.href)
  </action>
  <verify>
Component renders without errors. TypeScript types correct. Navigation items display properly.
  </verify>
  <done>
AdminSidebar displays navigation for all admin sections with proper active state highlighting and admin badge.
  </done>
</task>

</tasks>

<verification>
1. Backend admin routes accessible with admin auth
2. Frontend admin layout redirects non-admins
3. AdminSidebar renders with all navigation items
4. Visiting /admin shows placeholder dashboard with sidebar
</verification>

<success_criteria>
- Admin route group exists at (admin)/admin/
- Backend /admin/metrics, /admin/users, /admin/orders endpoints work
- Non-admin users redirected to /dashboard
- Admin users see sidebar with all navigation links
- Active navigation state works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-dashboard/08-01-SUMMARY.md`
</output>
