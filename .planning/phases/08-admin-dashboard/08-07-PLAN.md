---
phase: 08-admin-dashboard
plan: 07
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - frontend/src/app/(admin)/admin/users/page.tsx
  - frontend/src/app/(admin)/admin/users/columns.tsx
  - frontend/src/app/(admin)/admin/users/[id]/page.tsx
  - backend/src/routes/admin.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all users with subscription status"
    - "Admin can view user details"
    - "Admin can change user tier"
    - "Admin can view user's payment history"
  artifacts:
    - path: "frontend/src/app/(admin)/admin/users/page.tsx"
      provides: "User list page with data table"
      contains: "DataTable"
    - path: "frontend/src/app/(admin)/admin/users/[id]/page.tsx"
      provides: "User detail/edit page"
      contains: "tier"
    - path: "backend/src/routes/admin.ts"
      provides: "User detail endpoint"
      contains: "GET /:id"
  key_links:
    - from: "frontend/src/app/(admin)/admin/users/page.tsx"
      to: "/admin/users"
      via: "API fetch"
      pattern: "fetch.*admin/users"
---

<objective>
Build user management interface with list view and detail/edit page.

Purpose: Enables admins to view and manage users and their subscriptions (ADMN-02 requirement).

Output:
- User list page with DataTable (includes subscription status)
- User detail page with edit capabilities
- Backend endpoint for single user with payment history
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-admin-dashboard/08-RESEARCH.md
@.planning/phases/08-admin-dashboard/08-01-SUMMARY.md
@.planning/phases/08-admin-dashboard/08-02-SUMMARY.md

# Backend admin routes from Plan 01:
@backend/src/routes/admin.ts
@backend/src/db/schema/users.ts
@backend/src/db/schema/subscriptions.ts
@backend/src/db/schema/payments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user detail and update endpoints to backend</name>
  <files>
    backend/src/routes/admin.ts
  </files>
  <action>
Add to backend/src/routes/admin.ts:

```typescript
// GET /admin/users/:id - Get user details with subscription and payment history
adminRoutes.get('/users/:id', authMiddleware, requireAdmin(), async (c) => {
  const userId = parseInt(c.req.param('id'))

  // Get user
  const user = await db.query.users.findFirst({
    where: eq(users.id, userId),
  })

  if (!user) {
    return c.json({ error: 'User not found' }, 404)
  }

  // Get active subscription if exists
  const subscription = await db.query.subscriptions.findFirst({
    where: and(
      eq(subscriptions.userId, userId),
      eq(subscriptions.status, 'active')
    ),
  })

  // Get payment history
  const userPayments = await db.query.payments.findMany({
    where: eq(payments.userId, userId),
    orderBy: desc(payments.createdAt),
    limit: 20,
  })

  // Remove sensitive fields
  const { passwordHash, ...safeUser } = user

  return c.json({
    user: safeUser,
    subscription,
    payments: userPayments,
  })
})

// PATCH /admin/users/:id - Update user tier
adminRoutes.patch('/users/:id', authMiddleware, requireAdmin(), zValidator('json', z.object({
  tier: z.enum(['free', 'member']).optional(),
  name: z.string().min(1).max(255).optional(),
})), async (c) => {
  const userId = parseInt(c.req.param('id'))
  const body = c.req.valid('json')

  // Check user exists
  const user = await db.query.users.findFirst({
    where: eq(users.id, userId),
  })

  if (!user) {
    return c.json({ error: 'User not found' }, 404)
  }

  // Update user
  const [updatedUser] = await db.update(users)
    .set({
      ...body,
      updatedAt: new Date(),
    })
    .where(eq(users.id, userId))
    .returning()

  // If tier changed to 'member' and no active subscription, create one
  // If tier changed to 'free', cancel any active subscription
  if (body.tier === 'member') {
    const existingSub = await db.query.subscriptions.findFirst({
      where: and(
        eq(subscriptions.userId, userId),
        eq(subscriptions.status, 'active')
      ),
    })

    if (!existingSub) {
      // Create manual subscription (admin grant)
      const startDate = new Date()
      const endDate = new Date()
      endDate.setFullYear(endDate.getFullYear() + 1) // 1 year

      await db.insert(subscriptions).values({
        userId,
        status: 'active',
        startDate,
        endDate,
      })
    }
  } else if (body.tier === 'free') {
    // Cancel active subscription
    await db.update(subscriptions)
      .set({
        status: 'cancelled',
        updatedAt: new Date(),
      })
      .where(and(
        eq(subscriptions.userId, userId),
        eq(subscriptions.status, 'active')
      ))
  }

  const { passwordHash, ...safeUser } = updatedUser

  return c.json({ user: safeUser })
})
```

Import needed: `zValidator` from '@hono/zod-validator', `z` from 'zod', `and` from 'drizzle-orm'.
  </action>
  <verify>
Backend compiles. GET /admin/users/:id returns user with subscription and payments. PATCH updates tier.
  </verify>
  <done>
User detail endpoint returns user, subscription, payments. User update endpoint changes tier and manages subscription.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create user list page with DataTable</name>
  <files>
    frontend/src/app/(admin)/admin/users/page.tsx
    frontend/src/app/(admin)/admin/users/columns.tsx
  </files>
  <action>
1. Create frontend/src/app/(admin)/admin/users/columns.tsx:

Column definitions:
- name: User name
- email: User email
- tier: Badge (member=default, free=secondary)
- isVerified: Checkmark or X icon
- subscription.status: Active/Expired/None
- subscription.endDate: Subscription expiry (if exists)
- createdAt: Join date
- actions: View details link

2. Create frontend/src/app/(admin)/admin/users/page.tsx:

Client component:
- Fetches users using getAdminUsers from lib/api/admin.ts
- Renders DataTable with columns
- Search input to filter by email or name
- Pagination (server-side pagination already in API)
- Click row or View action to go to /admin/users/[id]

For pagination, track page state and refetch when page changes.
  </action>
  <verify>
User list renders with tier badges and subscription status.
  </verify>
  <done>
User list shows all users with tier, verification status, and subscription info.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create user detail/edit page</name>
  <files>
    frontend/src/app/(admin)/admin/users/[id]/page.tsx
  </files>
  <action>
Create frontend/src/app/(admin)/admin/users/[id]/page.tsx:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Separator } from '@/components/ui/separator'
import { format } from 'date-fns'
import { id as idLocale } from 'date-fns/locale'

// Fetch user, subscription, payments from /admin/users/:id
// Display:
// 1. User Info Card:
//    - Name, Email, Verified status
//    - Current tier with dropdown to change
//    - Save button if tier changed
//
// 2. Subscription Card (if exists):
//    - Status badge
//    - Start date, End date
//    - Days remaining (calculated)
//
// 3. Payment History Table:
//    - Recent payments (simplified table, not full DataTable)
//    - Columns: Date, Type, Amount, Status, Payment Method
//    - Link to full order details if needed

export default function UserDetailPage() {
  const params = useParams()
  const router = useRouter()
  const [user, setUser] = useState(null)
  const [subscription, setSubscription] = useState(null)
  const [payments, setPayments] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedTier, setSelectedTier] = useState('')
  const [saving, setSaving] = useState(false)

  // Fetch user data on mount
  // Handle tier change with PATCH
  // Format dates in Indonesian locale
  // Show payment amounts in IDR format

  async function handleTierChange(newTier: string) {
    setSaving(true)
    try {
      // PATCH /admin/users/:id with { tier: newTier }
      // Refresh user data
    } finally {
      setSaving(false)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">User Details</h1>
        <Button variant="outline" onClick={() => router.back()}>
          Back
        </Button>
      </div>

      {/* User Info Card */}
      {/* Subscription Card */}
      {/* Payment History */}
    </div>
  )
}
```

Features:
- Tier dropdown to change free/member
- Changing tier automatically creates/cancels subscription (backend handles this)
- Payment history shows recent transactions
- All dates in Indonesian format
- Currency in IDR
  </action>
  <verify>
User detail page loads user data. Tier change updates user and subscription.
  </verify>
  <done>
User detail page displays info, subscription, payment history. Admin can change tier via dropdown.
  </done>
</task>

</tasks>

<verification>
1. User list shows all users with subscription status
2. Search filters users by email/name
3. User detail page shows full info
4. Tier dropdown allows changing user tier
5. Payment history displays for user
</verification>

<success_criteria>
- Admin can view all users in DataTable
- Admin can search users by email or name
- Admin can view user details including subscription
- Admin can change user tier (free/member)
- Admin can see user's payment history
</success_criteria>

<output>
After completion, create `.planning/phases/08-admin-dashboard/08-07-SUMMARY.md`
</output>
