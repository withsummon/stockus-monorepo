---
phase: 09-docker-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/Dockerfile
  - backend/.dockerignore
autonomous: true

must_haves:
  truths:
    - "Backend Docker image builds successfully"
    - "Backend image runs as non-root user"
    - "Backend image includes health check"
    - "Build uses multi-stage pattern for optimization"
  artifacts:
    - path: "backend/Dockerfile"
      provides: "Multi-stage Docker build configuration"
      contains: "FROM node:20-slim"
    - path: "backend/.dockerignore"
      provides: "Build context exclusions"
      contains: "node_modules"
  key_links:
    - from: "backend/Dockerfile"
      to: "backend/dist/index.js"
      via: "CMD directive"
      pattern: "node dist/index.js"
---

<objective>
Create production-ready Docker configuration for the Hono backend API server.

Purpose: Enable containerized deployment of the backend with optimized image size, security (non-root user), and health checks for orchestration.
Output: Dockerfile with multi-stage build and .dockerignore for build optimization
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-docker-deployment/09-RESEARCH.md

@backend/package.json
@backend/src/routes/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend .dockerignore</name>
  <files>backend/.dockerignore</files>
  <action>
Create .dockerignore file to exclude unnecessary files from Docker build context.

Include these exclusions:
- node_modules (will be installed in container)
- npm-debug.log*, .pnpm-debug.log*
- dist (will be built in container)
- .env, .env*.local (secrets passed at runtime)
- .git, .gitignore
- Dockerfile*, docker-compose*, .dockerignore
- .vscode, .idea, *.swp, *.swo, *~
- .DS_Store, Thumbs.db
- coverage, .nyc_output
- *.log, README.md, LICENSE
- drizzle/*.sql (migrations will be copied separately if needed)

This reduces build context size by 70-90%, speeding up builds.
  </action>
  <verify>File exists at backend/.dockerignore with node_modules and .env exclusions</verify>
  <done>.dockerignore contains all standard exclusions for Node.js Docker builds</done>
</task>

<task type="auto">
  <name>Task 2: Create backend Dockerfile</name>
  <files>backend/Dockerfile</files>
  <action>
Create multi-stage Dockerfile for Hono backend. The backend uses npm (not pnpm) based on package-lock.json.

**Stage 1 - prod-deps**: Install production dependencies only
- FROM node:20-slim AS prod-deps
- WORKDIR /app
- COPY package.json package-lock.json ./
- RUN npm ci --only=production

**Stage 2 - build**: Build TypeScript application
- FROM node:20-slim AS build
- WORKDIR /app
- COPY package.json package-lock.json ./
- RUN npm ci
- COPY . .
- RUN npm run build

**Stage 3 - runner**: Production runtime
- FROM node:20-slim AS runner
- WORKDIR /app
- ENV NODE_ENV=production
- Create non-root user: addgroup --system --gid 1001 nodejs && adduser --system --uid 1001 hono
- COPY --from=prod-deps --chown=hono:nodejs /app/node_modules ./node_modules
- COPY --from=build --chown=hono:nodejs /app/dist ./dist
- COPY --from=build --chown=hono:nodejs /app/package.json ./
- USER hono
- EXPOSE 3000 (Note: backend runs on PORT from env, default 3001, but in Docker we'll use 3000)
- HEALTHCHECK with node http module to call http://localhost:3000/health
- CMD ["node", "dist/index.js"]

**Important:** Use node:20-slim (not alpine) because argon2 native dependency compiles better on Debian-based images. Alpine would require additional build tools for argon2.

Health check command:
HEALTHCHECK --interval=12s --timeout=5s --start-period=30s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
  </action>
  <verify>
Run: docker build -t stockus-backend-test ./backend
Verify build completes without errors.
Run: docker run --rm stockus-backend-test node --version (should show v20.x)
  </verify>
  <done>Dockerfile builds successfully with multi-stage pattern, non-root user, and health check</done>
</task>

</tasks>

<verification>
1. backend/Dockerfile exists with FROM node:20-slim
2. backend/.dockerignore exists with node_modules exclusion
3. Dockerfile contains USER hono (non-root)
4. Dockerfile contains HEALTHCHECK directive
5. Dockerfile uses multi-stage build (AS prod-deps, AS build, AS runner)
</verification>

<success_criteria>
- Backend Dockerfile builds without errors
- Image uses multi-stage build pattern
- Final stage runs as non-root user (UID 1001)
- Health check configured for /health endpoint
- .dockerignore excludes node_modules, .env, and other unnecessary files
</success_criteria>

<output>
After completion, create `.planning/phases/09-docker-deployment/09-01-SUMMARY.md`
</output>
