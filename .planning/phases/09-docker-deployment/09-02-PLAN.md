---
phase: 09-docker-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/next.config.ts
  - frontend/src/app/api/health/route.ts
  - frontend/Dockerfile
  - frontend/.dockerignore
autonomous: true

must_haves:
  truths:
    - "Frontend Docker image builds successfully"
    - "Frontend image runs as non-root user"
    - "Frontend health endpoint responds to /api/health"
    - "Next.js uses standalone output mode"
  artifacts:
    - path: "frontend/next.config.ts"
      provides: "Next.js configuration with standalone output"
      contains: "output: 'standalone'"
    - path: "frontend/src/app/api/health/route.ts"
      provides: "Health check endpoint for Docker"
      exports: ["GET"]
    - path: "frontend/Dockerfile"
      provides: "Multi-stage Docker build configuration"
      contains: "FROM node:20-alpine"
    - path: "frontend/.dockerignore"
      provides: "Build context exclusions"
      contains: "node_modules"
  key_links:
    - from: "frontend/Dockerfile"
      to: ".next/standalone/server.js"
      via: "CMD directive"
      pattern: "node server.js"
---

<objective>
Create production-ready Docker configuration for the Next.js frontend with standalone output mode.

Purpose: Enable containerized deployment of the frontend with optimized image size (~300-450MB instead of 1.2GB), security (non-root user), and health checks for orchestration.
Output: Updated next.config.ts, health endpoint, Dockerfile, and .dockerignore
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-docker-deployment/09-RESEARCH.md

@frontend/package.json
@frontend/next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update next.config.ts for standalone output</name>
  <files>frontend/next.config.ts</files>
  <action>
Update next.config.ts to add output: 'standalone' for Docker optimization.

The current config has:
- reactCompiler: true
- images.remotePatterns for R2

Add output: 'standalone' to the config object. This is REQUIRED for the Docker build pattern that copies from .next/standalone instead of full node_modules.

Final config should look like:
```typescript
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  output: 'standalone',
  reactCompiler: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.r2.cloudflarestorage.com',
      },
    ],
  },
}

export default nextConfig
```

IMPORTANT: Place output: 'standalone' first for visibility as it's the key Docker-related setting.
  </action>
  <verify>
Read frontend/next.config.ts and confirm output: 'standalone' is present
  </verify>
  <done>next.config.ts includes output: 'standalone' configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create frontend health endpoint</name>
  <files>frontend/src/app/api/health/route.ts</files>
  <action>
Create health check endpoint at /api/health for Docker health checks.

The endpoint should:
- Export GET handler
- Return JSON with status: 'ok' and timestamp
- Return 200 status code

Implementation:
```typescript
export async function GET() {
  return Response.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
  })
}
```

This endpoint will be called by Docker HEALTHCHECK to verify the frontend is responsive.
  </action>
  <verify>
Run: curl http://localhost:3000/api/health (when dev server is running)
Or verify file exists with GET export
  </verify>
  <done>Health endpoint responds with {status: 'ok', timestamp: ...}</done>
</task>

<task type="auto">
  <name>Task 3: Create frontend Dockerfile and .dockerignore</name>
  <files>frontend/Dockerfile, frontend/.dockerignore</files>
  <action>
**Create frontend/.dockerignore first:**

Exclude these from build context:
- node_modules
- npm-debug.log*, .pnpm-debug.log*
- .next (will be built in container)
- out, dist, build
- .env, .env*.local
- .git, .gitignore
- Dockerfile*, docker-compose*, .dockerignore
- .vscode, .idea, *.swp, *.swo, *~
- .DS_Store, Thumbs.db
- coverage, .nyc_output
- *.log, README.md, LICENSE

**Create frontend/Dockerfile:**

Frontend uses npm (has package-lock.json). Use Alpine for frontend since no native dependencies like argon2.

**Stage 1 - deps**: Install dependencies
- FROM node:20-alpine AS deps
- RUN apk add --no-cache libc6-compat (required for some npm packages)
- WORKDIR /app
- COPY package.json package-lock.json ./
- RUN npm ci

**Stage 2 - builder**: Build Next.js application
- FROM node:20-alpine AS builder
- WORKDIR /app
- COPY --from=deps /app/node_modules ./node_modules
- COPY . .
- ENV NEXT_TELEMETRY_DISABLED=1
- RUN npm run build

**Stage 3 - runner**: Production runtime
- FROM node:20-alpine AS runner
- WORKDIR /app
- ENV NODE_ENV=production
- ENV NEXT_TELEMETRY_DISABLED=1
- Create non-root user: addgroup --system --gid 1001 nodejs && adduser --system --uid 1001 nextjs
- COPY --from=builder /app/public ./public
- COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
- COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
- USER nextjs
- EXPOSE 3000
- ENV PORT=3000
- ENV HOSTNAME="0.0.0.0"
- HEALTHCHECK with node http module to call http://localhost:3000/api/health
- CMD ["node", "server.js"]

Health check command:
HEALTHCHECK --interval=12s --timeout=5s --start-period=30s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
  </action>
  <verify>
Run: docker build -t stockus-frontend-test ./frontend
Verify build completes without errors.
  </verify>
  <done>Dockerfile builds with standalone output, non-root user, and health check; .dockerignore excludes build context bloat</done>
</task>

</tasks>

<verification>
1. frontend/next.config.ts contains output: 'standalone'
2. frontend/src/app/api/health/route.ts exists and exports GET
3. frontend/Dockerfile exists with FROM node:20-alpine
4. frontend/.dockerignore exists with node_modules exclusion
5. Dockerfile contains USER nextjs (non-root)
6. Dockerfile contains HEALTHCHECK directive
7. Dockerfile copies from .next/standalone (not full node_modules)
</verification>

<success_criteria>
- next.config.ts has output: 'standalone' setting
- Health endpoint created at /api/health
- Frontend Dockerfile builds without errors
- Image uses multi-stage build with standalone output
- Final stage runs as non-root user (UID 1001)
- Health check configured for /api/health endpoint
- .dockerignore excludes node_modules, .env, .next
</success_criteria>

<output>
After completion, create `.planning/phases/09-docker-deployment/09-02-SUMMARY.md`
</output>
