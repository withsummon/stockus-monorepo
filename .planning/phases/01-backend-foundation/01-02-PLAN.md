---
phase: 01-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/src/index.ts
  - backend/src/app.ts
  - backend/src/routes/index.ts
  - backend/src/routes/health.ts
  - backend/src/db/schema/index.ts
  - backend/src/db/schema/users.ts
  - backend/src/db/migrate.ts
  - backend/drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Hono server starts and listens on configured PORT"
    - "GET /health returns 200 with status: ok"
    - "GET /health/ready checks database connectivity"
    - "Database migrations can be generated and run"
    - "Routes are organized in modular structure"
  artifacts:
    - path: "backend/src/index.ts"
      provides: "Server entry point with graceful shutdown"
      contains: "serve"
    - path: "backend/src/app.ts"
      provides: "Hono application instance"
      exports: ["default"]
    - path: "backend/src/routes/health.ts"
      provides: "Health check endpoints"
      contains: "/ready"
    - path: "backend/src/db/schema/users.ts"
      provides: "Users table schema"
      contains: "pgTable"
    - path: "backend/drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "defineConfig"
  key_links:
    - from: "backend/src/index.ts"
      to: "backend/src/app.ts"
      via: "import app"
      pattern: "import.*app.*from.*app"
    - from: "backend/src/app.ts"
      to: "backend/src/routes/index.ts"
      via: "app.route() mounting"
      pattern: "app\\.route.*routes"
    - from: "backend/src/routes/health.ts"
      to: "backend/src/db/index.ts"
      via: "database health check"
      pattern: "import.*db.*from.*db"
    - from: "backend/src/db/index.ts"
      to: "backend/src/db/schema/index.ts"
      via: "schema import for relational queries"
      pattern: "import.*schema"
---

<objective>
Create Hono application with modular route organization, health check endpoints, database schema, and migration infrastructure.

Purpose: Complete the backend foundation by adding the application layer - server, routes, and database schema that enables all future API development.

Output: Running Hono server with health endpoint, users table schema, working migration workflow.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md
@.planning/phases/01-backend-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hono app with modular route structure</name>
  <files>
    backend/src/app.ts
    backend/src/routes/index.ts
    backend/src/routes/health.ts
    backend/src/index.ts
  </files>
  <action>
Create the Hono application with modular route organization:

1. Create `backend/src/routes/health.ts`:
   ```typescript
   import { Hono } from 'hono'
   import { db } from '../db/index.js'
   import { sql } from 'drizzle-orm'

   const health = new Hono()

   // Basic health check
   health.get('/', (c) => {
     return c.json({
       status: 'ok',
       timestamp: new Date().toISOString(),
       uptime: process.uptime(),
     })
   })

   // Readiness check with database connectivity
   health.get('/ready', async (c) => {
     try {
       await db.execute(sql`SELECT 1`)
       return c.json({ status: 'ready', database: 'connected' })
     } catch (error) {
       return c.json(
         { status: 'not ready', database: 'disconnected', error: error instanceof Error ? error.message : 'Unknown error' },
         503
       )
     }
   })

   export default health
   ```

2. Create `backend/src/routes/index.ts`:
   ```typescript
   import { Hono } from 'hono'
   import health from './health.js'

   const routes = new Hono()

   routes.route('/health', health)

   export default routes
   ```

3. Create `backend/src/app.ts`:
   ```typescript
   import { Hono } from 'hono'
   import { logger } from 'hono/logger'
   import routes from './routes/index.js'

   const app = new Hono()

   // Middleware
   app.use('*', logger())

   // Mount routes
   app.route('/', routes)

   // Root endpoint
   app.get('/', (c) => {
     return c.json({ message: 'StockUs API', version: '1.0.0' })
   })

   export default app
   ```

4. Create `backend/src/index.ts`:
   ```typescript
   import { serve } from '@hono/node-server'
   import app from './app.js'
   import { env } from './config/env.js'
   import { pool } from './db/index.js'

   const server = serve({
     fetch: app.fetch,
     port: env.PORT,
   }, (info) => {
     console.log(`Server listening on http://localhost:${info.port}`)
   })

   // Graceful shutdown
   const shutdown = async () => {
     console.log('Shutting down gracefully...')
     server.close()
     await pool.end()
     console.log('Server closed')
     process.exit(0)
   }

   process.on('SIGINT', shutdown)
   process.on('SIGTERM', shutdown)
   ```

Key patterns from research:
- Use app.route() for modular organization (preserves TypeScript inference)
- Use .js extensions in imports (required for ESM)
- Inline handlers (don't separate into controller classes)
  </action>
  <verify>
1. Start server: `cd backend && npm run dev`
2. In another terminal:
   - `curl http://localhost:3001/` should return {"message":"StockUs API","version":"1.0.0"}
   - `curl http://localhost:3001/health` should return {"status":"ok","timestamp":"...","uptime":...}
3. Stop server with Ctrl+C (should show graceful shutdown message)
  </verify>
  <done>
Hono server starts on PORT from env, responds to root and health endpoints, shuts down gracefully on SIGINT/SIGTERM
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and migration infrastructure</name>
  <files>
    backend/src/db/schema/index.ts
    backend/src/db/schema/users.ts
    backend/src/db/migrate.ts
    backend/drizzle.config.ts
  </files>
  <action>
Create Drizzle schema and migration tooling:

1. Create `backend/src/db/schema/users.ts`:
   ```typescript
   import { pgTable, serial, varchar, timestamp, boolean } from 'drizzle-orm/pg-core'

   export const users = pgTable('users', {
     id: serial('id').primaryKey(),
     email: varchar('email', { length: 255 }).notNull().unique(),
     name: varchar('name', { length: 255 }).notNull(),
     passwordHash: varchar('password_hash', { length: 255 }),
     isVerified: boolean('is_verified').default(false).notNull(),
     createdAt: timestamp('created_at').defaultNow().notNull(),
     updatedAt: timestamp('updated_at').defaultNow().notNull(),
   })
   ```

2. Create `backend/src/db/schema/index.ts`:
   ```typescript
   export * from './users.js'
   ```

3. Update `backend/src/db/index.ts` to include schema:
   - Add: `import * as schema from './schema/index.js'`
   - Update drizzle call: `export const db = drizzle({ client: pool, schema })`

4. Create `backend/drizzle.config.ts`:
   ```typescript
   import 'dotenv/config'
   import { defineConfig } from 'drizzle-kit'

   export default defineConfig({
     out: './drizzle',
     schema: './src/db/schema/index.ts',
     dialect: 'postgresql',
     dbCredentials: {
       url: process.env.DATABASE_URL!,
     },
     verbose: true,
     strict: true,
   })
   ```

5. Create `backend/src/db/migrate.ts`:
   ```typescript
   import 'dotenv/config'
   import { drizzle } from 'drizzle-orm/node-postgres'
   import { migrate } from 'drizzle-orm/node-postgres/migrator'
   import { Pool } from 'pg'

   const runMigrations = async () => {
     const migrationClient = new Pool({
       connectionString: process.env.DATABASE_URL,
       max: 1,
     })

     const db = drizzle({ client: migrationClient })

     console.log('Running migrations...')
     await migrate(db, { migrationsFolder: './drizzle' })
     console.log('Migrations complete')

     await migrationClient.end()
   }

   runMigrations().catch((err) => {
     console.error('Migration failed:', err)
     process.exit(1)
   })
   ```

6. Create `backend/drizzle/` directory (empty, will be populated by drizzle-kit generate)
  </action>
  <verify>
1. Generate migration: `cd backend && npm run db:generate`
   - Should create SQL file in backend/drizzle/
   - Check: `ls backend/drizzle/*.sql`

2. TypeScript compiles: `cd backend && npx tsc --noEmit`
   - Should complete without errors
  </verify>
  <done>
Users table schema defined, drizzle-kit configured, migration generation works, migration runner script ready
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete backend foundation</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
Perform end-to-end verification of the backend foundation:

1. Start PostgreSQL (if not running):
   - If using Docker: `docker run --name stockus-pg -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=stockus -p 5432:5432 -d postgres:15`
   - Wait for startup: `sleep 3`

2. Run migrations:
   - `cd backend && npm run db:migrate`
   - Should output "Migrations complete"

3. Start server:
   - `cd backend && npm run dev &`
   - Wait for startup: `sleep 2`

4. Test all endpoints:
   - `curl http://localhost:3001/` - root endpoint
   - `curl http://localhost:3001/health` - basic health
   - `curl http://localhost:3001/health/ready` - database health

5. Verify database table:
   - `docker exec stockus-pg psql -U postgres -d stockus -c "\\d users"`
   - Should show users table structure

6. Cleanup:
   - Kill dev server
   - Optionally stop postgres: `docker stop stockus-pg`

If PostgreSQL is not available locally, skip steps 1, 2, 5 and verify that /health/ready returns 503 (expected behavior when database unavailable).
  </action>
  <verify>
All success criteria from Phase 1 met:
1. Hono server starts and responds to health check endpoint - YES (curl /health returns 200)
2. PostgreSQL connection established via Drizzle ORM - YES (curl /health/ready returns 200 with database: connected)
3. Database migrations run successfully - YES (npm run db:migrate completes)
4. Project structure supports modular route organization - YES (routes/ folder with separate files)
5. Environment configuration loads from .env - YES (server starts on PORT from .env)
  </verify>
  <done>
Complete backend foundation verified: server running, database connected, migrations working, modular structure established
  </done>
</task>

</tasks>

<verification>
Phase 1 Success Criteria verification:

1. **Hono server starts and responds to health check endpoint**
   - `curl http://localhost:3001/health` returns `{"status":"ok",...}`

2. **PostgreSQL connection established via Drizzle ORM**
   - `curl http://localhost:3001/health/ready` returns `{"status":"ready","database":"connected"}`

3. **Database migrations run successfully**
   - `npm run db:generate` creates migration files
   - `npm run db:migrate` applies migrations without error

4. **Project structure supports modular route organization**
   - `ls backend/src/routes/` shows index.ts and health.ts
   - New routes can be added by creating file and mounting in index.ts

5. **Environment configuration loads from .env**
   - Server starts on port specified in .env (3001)
   - Invalid/missing DATABASE_URL causes startup failure
</verification>

<success_criteria>
- Hono server running and responding to requests
- Health endpoints working (/ and /ready)
- Users table schema created in database
- Migration workflow functional (generate + migrate)
- Modular route structure established
- Graceful shutdown on SIGINT/SIGTERM
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-02-SUMMARY.md`
</output>
