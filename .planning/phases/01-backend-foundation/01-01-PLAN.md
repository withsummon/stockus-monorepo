---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/.env.example
  - backend/.env
  - backend/.gitignore
  - backend/src/config/env.ts
  - backend/src/db/index.ts
autonomous: true

must_haves:
  truths:
    - "Environment variables load and validate at startup"
    - "DATABASE_URL connection string is validated"
    - "PostgreSQL connection pool is established"
    - "Pool error handler is configured"
  artifacts:
    - path: "backend/package.json"
      provides: "Project dependencies"
      contains: "hono"
    - path: "backend/tsconfig.json"
      provides: "TypeScript configuration"
      contains: "strict"
    - path: "backend/src/config/env.ts"
      provides: "Validated environment config"
      exports: ["env"]
    - path: "backend/src/db/index.ts"
      provides: "Database connection with pooling"
      exports: ["db", "pool"]
  key_links:
    - from: "backend/src/config/env.ts"
      to: "process.env"
      via: "Zod validation at startup"
      pattern: "z\\.object.*DATABASE_URL"
    - from: "backend/src/db/index.ts"
      to: "backend/src/config/env.ts"
      via: "import env for connection string"
      pattern: "import.*env.*from.*config"
---

<objective>
Initialize backend project with TypeScript, validated environment configuration, and PostgreSQL database connection via Drizzle ORM with connection pooling.

Purpose: Establish the foundation layer that all other backend code depends on - package management, TypeScript, environment validation, and database connectivity.

Output: Working backend folder with dependencies installed, TypeScript configured, environment validation passing, and database pool ready for queries.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize backend project with dependencies</name>
  <files>
    backend/package.json
    backend/tsconfig.json
    backend/.gitignore
  </files>
  <action>
Create backend/ directory and initialize npm project:

1. Create `backend/package.json` with:
   - name: "stockus-backend"
   - type: "module" (ESM)
   - scripts:
     - "dev": "tsx watch src/index.ts"
     - "build": "tsc"
     - "start": "node dist/index.js"
     - "db:generate": "drizzle-kit generate"
     - "db:migrate": "tsx src/db/migrate.ts"
     - "db:studio": "drizzle-kit studio"
   - dependencies: hono, @hono/node-server, drizzle-orm, pg, zod, dotenv
   - devDependencies: tsx, typescript, @types/node, @types/pg, drizzle-kit

2. Create `backend/tsconfig.json` with:
   - target: "ES2022"
   - module: "NodeNext"
   - moduleResolution: "NodeNext"
   - strict: true
   - outDir: "./dist"
   - rootDir: "./src"
   - esModuleInterop: true
   - skipLibCheck: true

3. Create `backend/.gitignore` with:
   - node_modules/
   - dist/
   - .env
   - *.log

4. Run `npm install` in backend directory

Note: Use ESM (type: module) not CommonJS - this is the modern standard and Hono works best with it.
  </action>
  <verify>
Run from backend directory:
- `cat package.json | grep '"type": "module"'` shows ESM config
- `ls node_modules/hono` confirms hono installed
- `ls node_modules/drizzle-orm` confirms drizzle installed
- `npx tsc --version` confirms TypeScript available
  </verify>
  <done>
backend/package.json exists with all dependencies, node_modules populated, TypeScript configured for ESM
  </done>
</task>

<task type="auto">
  <name>Task 2: Create environment configuration with Zod validation</name>
  <files>
    backend/.env.example
    backend/.env
    backend/src/config/env.ts
  </files>
  <action>
Create environment configuration that validates at startup:

1. Create `backend/.env.example` with documented variables:
   ```
   # Server
   NODE_ENV=development
   PORT=3001

   # Database
   DATABASE_URL=postgresql://user:password@localhost:5432/stockus

   # Logging
   LOG_LEVEL=info
   ```

2. Create `backend/.env` with actual development values:
   ```
   NODE_ENV=development
   PORT=3001
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/stockus
   LOG_LEVEL=debug
   ```

3. Create `backend/src/config/env.ts`:
   - Import dotenv/config at top (side-effect import)
   - Define Zod schema for all environment variables:
     - NODE_ENV: enum ['development', 'production', 'test'], default 'development'
     - PORT: string transformed to number (1-65535), default '3001'
     - DATABASE_URL: string URL
     - LOG_LEVEL: enum ['debug', 'info', 'warn', 'error'], default 'info'
   - Parse process.env immediately (fail fast if invalid)
   - Export `env` object and `Env` type

Key pattern from research: Use `import 'dotenv/config'` as first import to ensure .env loaded before any other modules access process.env.
  </action>
  <verify>
Run: `cd backend && npx tsx -e "import { env } from './src/config/env.ts'; console.log('PORT:', env.PORT, 'NODE_ENV:', env.NODE_ENV)"`
Should output: PORT: 3001 NODE_ENV: development
  </verify>
  <done>
Environment variables load from .env file and are validated with Zod, invalid config causes immediate startup failure with clear error message
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database connection with pooling</name>
  <files>
    backend/src/db/index.ts
  </files>
  <action>
Create PostgreSQL connection using pg.Pool and Drizzle ORM:

1. Create `backend/src/db/index.ts`:
   - Import Pool from 'pg'
   - Import drizzle from 'drizzle-orm/node-postgres'
   - Import env from '../config/env.ts'

   - Create Pool instance with:
     - connectionString: env.DATABASE_URL
     - max: 20 (maximum pool size)
     - idleTimeoutMillis: 30000 (30 seconds)
     - connectionTimeoutMillis: 2000 (2 seconds)

   - Add pool error listener:
     ```typescript
     pool.on('error', (err) => {
       console.error('Unexpected pool error:', err)
       process.exit(-1)
     })
     ```

   - Create Drizzle instance:
     ```typescript
     export const db = drizzle({ client: pool })
     ```

   - Export both `db` (for queries) and `pool` (for direct access/shutdown)

Note: Don't pass schema to drizzle yet - we'll add it in Plan 02 when we create the schema files.
  </action>
  <verify>
Run: `cd backend && npx tsx -e "import { pool } from './src/db/index.ts'; pool.query('SELECT 1').then(() => { console.log('Database connected'); pool.end(); }).catch(e => console.error('Connection failed:', e.message))"`

If PostgreSQL is running: "Database connected"
If not running: "Connection failed: connect ECONNREFUSED" (expected if no local PG)
  </verify>
  <done>
Database module exports db (Drizzle instance) and pool (pg.Pool), connection pooling configured with appropriate limits, error handler installed
  </done>
</task>

</tasks>

<verification>
1. All files exist in expected locations:
   - backend/package.json
   - backend/tsconfig.json
   - backend/src/config/env.ts
   - backend/src/db/index.ts

2. Dependencies installed:
   - `cd backend && npm ls hono @hono/node-server drizzle-orm pg zod`

3. TypeScript compiles without errors:
   - `cd backend && npx tsc --noEmit`

4. Environment validation works:
   - Valid .env loads successfully
   - Missing DATABASE_URL would cause startup failure
</verification>

<success_criteria>
- Backend project initialized with ESM TypeScript configuration
- All dependencies (hono, drizzle-orm, pg, zod) installed
- Environment variables validated at startup with Zod
- Database connection pool configured and exported
- TypeScript compilation succeeds with strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>
